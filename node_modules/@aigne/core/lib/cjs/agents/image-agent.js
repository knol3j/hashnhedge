"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImageAgent = exports.imageAgentOptionsSchema = void 0;
const zod_1 = __importDefault(require("zod"));
const prompt_builder_js_1 = require("../prompt/prompt-builder.js");
const type_utils_js_1 = require("../utils/type-utils.js");
const agent_js_1 = require("./agent.js");
const image_model_js_1 = require("./image-model.js");
exports.imageAgentOptionsSchema = agent_js_1.agentOptionsSchema.extend({
    model: zod_1.default.custom().optional(),
    instructions: zod_1.default.union([zod_1.default.string(), zod_1.default.custom()]),
    modelOptions: zod_1.default.record(zod_1.default.any()).optional(),
});
class ImageAgent extends agent_js_1.Agent {
    tag = "ImageAgent";
    static from(options) {
        return new ImageAgent(options);
    }
    constructor(options) {
        super({ ...options, outputSchema: image_model_js_1.imageModelOutputSchema });
        (0, type_utils_js_1.checkArguments)("ImageAgent", exports.imageAgentOptionsSchema, options);
        this.model = options.model;
        this.instructions =
            typeof options.instructions === "string"
                ? prompt_builder_js_1.PromptBuilder.from(options.instructions)
                : options.instructions;
        this.modelOptions = options.modelOptions;
    }
    model;
    instructions;
    modelOptions;
    async process(input, options) {
        const model = this.model ?? options.context.imageModel;
        if (!model)
            throw new Error("image model is required to run ImageAgent");
        const { prompt } = await this.instructions.buildImagePrompt({ input });
        return (await options.context.invoke(model, { ...input, ...this.modelOptions, prompt }, { ...options, streaming: false }));
    }
}
exports.ImageAgent = ImageAgent;
