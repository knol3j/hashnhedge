"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadAgentFromJsFile = loadAgentFromJsFile;
const ufo_1 = require("ufo");
const agent_js_1 = require("../agents/agent.js");
const type_utils_js_1 = require("../utils/type-utils.js");
const agent_yaml_js_1 = require("./agent-yaml.js");
const importFn = new Function("path", "return import(path)");
async function loadAgentFromJsFile(path, options) {
    if (options?.key)
        path = (0, ufo_1.withQuery)(path, { key: options?.key });
    const { default: agent } = await (0, type_utils_js_1.tryOrThrow)(() => importFn(path), (error) => new Error(`Failed to load agent definition from ${path}: ${error.message}`));
    if (agent instanceof agent_js_1.Agent)
        return agent;
    if (typeof agent !== "function") {
        throw new Error(`Agent file ${path} must export a default function, but got ${typeof agent}`);
    }
    return (0, type_utils_js_1.tryOrThrow)(() => (0, agent_yaml_js_1.parseAgentFile)(path, {
        ...agent,
        type: "function",
        name: agent.agent_name || agent.agentName || agent.name,
        process: agent,
    }), (error) => new Error(`Failed to parse agent from ${path}: ${error.message}`));
}
