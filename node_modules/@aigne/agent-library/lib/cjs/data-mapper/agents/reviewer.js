"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@aigne/core");
const zod_1 = require("zod");
const tools_js_1 = require("../tools.js");
const reviewer = core_1.FunctionAgent.from({
    name: "check_mapping",
    description: "Check the mapping result",
    subscribeTopic: ["review_request"],
    publishTopic: (output) => (output.success ? core_1.UserOutputTopic : "mapping_request"),
    inputSchema: zod_1.z.object({
        sourceData: zod_1.z.string(),
        jsonata: zod_1.z.string(),
        responseSchema: zod_1.z.string(),
    }),
    process: async ({ sourceData, jsonata, responseSchema, }) => {
        let parsedSourceData = null;
        let parsedResponseSchema = null;
        try {
            parsedSourceData = sourceData ? JSON.parse(sourceData) : null;
            parsedResponseSchema = responseSchema ? JSON.parse(responseSchema) : null;
        }
        catch (parseError) {
            // input data is not valid JSON, return success
            return {
                success: true,
                data: null,
                feedback: `JSON parsing failed: ${parseError.message}`,
            };
        }
        const transformation = await (0, tools_js_1.applyJsonataWithValidation)(parsedSourceData, jsonata, parsedResponseSchema);
        // if transformation is successful, return success
        if (transformation.success) {
            return {
                success: true,
                data: transformation.data,
            };
        }
        return {
            success: transformation.success,
            data: transformation.data,
            feedback: transformation.error,
        };
    },
    includeInputInOutput: true,
});
exports.default = reviewer;
