"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.initDatabase = initDatabase;
const client_1 = require("@libsql/client");
const libsql_1 = require("drizzle-orm/libsql");
const retry_js_1 = require("./retry.js");
async function initDatabase({ url = ":memory:", wal = false, } = {}) {
    let db;
    if (wal) {
        const client = (0, client_1.createClient)({ url });
        await client.execute(`\
PRAGMA journal_mode = WAL;
PRAGMA synchronous = normal;
PRAGMA wal_autocheckpoint = 5000;
PRAGMA busy_timeout = 5000;
`);
        db = (0, libsql_1.drizzle)(client);
    }
    else {
        db = (0, libsql_1.drizzle)(url);
    }
    if ("session" in db && db.session && typeof db.session === "object") {
        db.session = (0, retry_js_1.withRetry)(db.session, [
            "all",
            "get",
            "run",
            "values",
            "count",
        ]);
    }
    return db;
}
