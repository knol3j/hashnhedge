{{/* Custom infinite scroll layout for Hash & Hedge */}}
{{ define "main" }}
{{- $config := site.Params }}
{{- $blog_dir := default "posts" $config.blogDir }}
{{- $pages := where site.RegularPages "Type" "in" $config.mainSections }}
<div class="wrap pt-2 mt-2">
  <div id="posts-container">
    {{/* Initial batch of posts */}}
    {{- range $index, $value := ($pages | first 12) }}
    {{ $bg := partial "func/getImage" . }}
    <article class="article mb-2" data-post-id="{{ $index }}">
      <a href="{{ $value.Permalink }}" {{ if eq $index 0 }} class="grid-reverse" {{ end }}>
        <div class="article_thumb" style='background-image: url({{ $bg }})'></div>
        <div class="article_meta {{ if eq $index 0 }} center_y {{ end }}">
          <time class="post_date">{{ dateFormat "January 02, 2006" $value.Date }}</time>
          <h3 class="article_title">{{ $value.Title }}</h3>
          <div class="article_excerpt {{ if eq $index 0 }} visible {{ end }}">
            <p>{{ truncate 100 $value.Summary }}</p>
          </div>
        </div>
      </a>
    </article>
    {{- end }}
  </div>
  
  {{/* Loading indicator */}}
  <div id="loading-indicator" class="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <p>Loading more stories...</p>
  </div>
  
  {{/* End of posts indicator */}}
  <div id="end-indicator" class="end-indicator" style="display: none;">
    <p>ðŸŽ‰ You've reached the end! That's all {{ len $pages }} stories.</p>
    <a href='{{ absURL (printf "%s/%s" $blog_dir "") }}' class="post_nav">
      <span class="post_next">Browse Archives 
        <svg class="icon icon_scale">
          <use xlink:href="#double-arrow"></use>
        </svg>
      </span>
    </a>
  </div>
</div>

{{/* Pass data to JavaScript */}}
<script>
window.hashHedgeInfiniteScroll = {
  totalPosts: {{ len $pages }},
  postsPerPage: 12,
  currentPage: 1,
  loading: false,
  allPostsData: [
    {{- range $index, $value := $pages }}
    {
      title: {{ $value.Title | jsonify }},
      permalink: {{ $value.Permalink | jsonify }},
      date: {{ dateFormat "January 02, 2006" $value.Date | jsonify }},
      summary: {{ (truncate 100 $value.Summary) | jsonify }},
      image: {{ (partial "func/getImage" .) | jsonify }}
    }{{ if ne $index (sub (len $pages) 1) }},{{ end }}
    {{- end }}
  ]
};
</script>

<style>
.loading-indicator {
  text-align: center;
  padding: 2rem;
  color: #666;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #663399;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.end-indicator {
  text-align: center;
  padding: 3rem 1rem;
  color: #666;
  border-top: 2px solid #eee;
  margin-top: 2rem;
}

.end-indicator p {
  font-size: 1.2rem;
  margin-bottom: 1rem;
}

.article {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Stagger animation for newly loaded posts */
.article.new-post {
  animation-delay: calc(var(--post-index) * 0.1s);
}
</style>
{{ end }}